<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Derivadas - Paso a Paso</title>

  <!-- Librerías -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
  <script src="https://unpkg.com/function-plot/dist/function-plot.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    input {
      padding: 8px;
      width: 300px;
      font-size: 1rem;
    }
    button {
      padding: 8px 15px;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    #output {
      margin-top: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0px 0px 5px rgba(0,0,0,0.1);
    }
    #plot {
      margin-top: 20px;
    }
    code {
      background: #eee;
      padding: 2px 5px;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<h1>📈 Calculadora de Derivadas - Paso a Paso</h1>
<p>Escribe una función en <b>x</b> (Ejemplo: <code>x^3 + 2x</code>, <code>sin(x)*x^2</code>, <code>(x^2+1)/(x-3)</code>)</p>

<input type="text" id="funcion" placeholder="Ej: x^3 + 2x">
<br>
<button onclick="resolverDerivada()">Calcular derivada</button>
<button onclick="descargarPDF()">📄 Descargar PDF</button>

<div id="output"></div>
<div id="plot"></div>

<script>
let pasosTexto = "";

function detectarRegla(termino) {
    if (/sin|cos|tan|log|exp/.test(termino) && /\*/.test(termino)) {
        return "Producto + Cadena";
    } else if (/\//.test(termino)) {
        return "Cociente";
    } else if (/sin|cos|tan|log|exp/.test(termino)) {
        return "Cadena";
    } else if (/\*/.test(termino)) {
        return "Producto";
    } else if (/x\^?\d*/.test(termino) && !isNaN(termino.replace("x",""))) {
        return "Potencia";
    } else if (/x/.test(termino)) {
        return "Potencia simple";
    } else {
        return "Constante";
    }
}

function generarExplicacion(funcion) {
    let terminos = funcion.split("+").map(t => t.trim());
    let pasosHTML = `<h3>📝 Proceso paso a paso:</h3><ol>`;
    pasosTexto += `Proceso paso a paso:\n`;

    terminos.forEach(t => {
        let regla = detectarRegla(t);
        pasosHTML += `<li><b>${t}</b>: Se aplica la regla de <b>${regla}</b>.</li>`;
        pasosTexto += `${t}: Se aplica la regla de ${regla}.\n`;
    });

    pasosHTML += `</ol>`;
    return pasosHTML;
}

function resolverDerivada() {
    const entrada = document.getElementById("funcion").value.trim();
    if (!entrada) {
        alert("Por favor ingresa una función.");
        return;
    }

    try {
        // Derivada
        const derivada = math.derivative(entrada, 'x').toString();
        const derivadaSimplificada = math.simplify(derivada).toString();

        // Explicación
        pasosTexto = `Cálculo de derivada para: f(x) = ${entrada}\n\n`;
        let explicacion = generarExplicacion(entrada);

        // Resultado
        let resultadoHTML = `
            ${explicacion}
            <p>\\[ f'(x) = ${derivada} \\]</p>
            <p>\\[ \\text{Simplificada: } f'(x) = ${derivadaSimplificada} \\]</p>
        `;

        document.getElementById("output").innerHTML = resultadoHTML;
        MathJax.typeset(); // Renderizar fórmulas

        pasosTexto += `\nDerivada final: ${derivadaSimplificada}`;

        // Gráfica
        functionPlot({
            target: '#plot',
            width: 700,
            height: 400,
            xAxis: { label: 'x' },
            yAxis: { label: 'y' },
            grid: true,
            data: [
                { fn: entrada, sampler: 'builtIn', graphType: 'polyline', color: 'blue', label: 'f(x)' },
                { fn: derivadaSimplificada, sampler: 'builtIn', graphType: 'polyline', color: 'red', label: "f'(x)" }
            ]
        });

    } catch (error) {
        alert("Error en la función. Verifica la sintaxis.");
        console.error(error);
    }
}

function descargarPDF() {
    if (!pasosTexto) {
        alert("Primero calcula la derivada.");
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text("Calculadora de Derivadas - Paso a Paso", 10, 10);
    doc.setFontSize(11);
    doc.text(pasosTexto, 10, 20);
    doc.save("derivada.pdf");
}
</script>

</body>
</html>
